name: Jira automation with deployment

on:
  push:
    branches: [ "main" ]

jobs:
  jira:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Jira script
        run: python liaison_intergalactique.py
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}

      - name: Send deployment info to Jira
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.JIRA_DEPLOY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
                  "deploymentSequenceNumber": 1,
                  "updateSequenceNumber": 1,
                  "displayName": "GitHub Actions Deployment",
                  "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "description": "DÃ©ploiement automatique via workflow",
                  "lastUpdated": "'$(date --iso-8601=seconds)'",
                  "state": "successful",
                  "associations": [
                    {
                      "issueKeys": ["EDT-7"],
                      "associationType": "issueIdOrKey"
                    }
                  ]
                }' \
            https://api.atlassian.com/deployment/0.1/bulk

